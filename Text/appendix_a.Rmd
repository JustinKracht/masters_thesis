---
output: pdf_document
---

```{r appx-a-setup, echo = TRUE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
generate_figs <- FALSE

pacman::p_load(ggplot2,
               here,
               dplyr,
               tidyr,
               patchwork)

results_matrix_npd <- readRDS(paste0(project_dir, 
                                     "/Data", 
                                     "/results_matrix_npd.RDS"))
```

# Imputation Proceedure

## Imputation Procedure for $\log \textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$

Missing values for $\textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$ occured when either the Higham (2002) or Bentler-Yuan (2011) algorithms did not converge. Without a smoothed correlation matrix, it was obviously not possible to calculate the distance between the smoothed and population correlation matrices. If the pattern of missingness was not missing completely at random (MCAR; i.e., the probability of missingness was independent of the value of the dependent variable), removing all observations with missing data could result in biased parameter estimates (Enders, 2010). To determine whether it was reasonable to assume that the data were MCAR, density plots of $\textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$ for the methods without non-convergence issues (Knol-Berger and no smoothing) were created. Separate density plots were created for cases where the Bentler-Yuan and Higham algorithms converged (when applied to the corresponding NPD correlation matrix) and those cases where at least one of the two smoothing algorithms did not converge (Figure \@ref(fig:RpopRsm-MNAR)). For both the Knol-Berger smoothed matrices and the unsmoothed NPD matrices, the distributions of $\textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$ for cases where the Higham and Bentler-Yuan algorithms converged and the cases where at least one did not converge were quite similar. If it is reasonable to use $\textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$ from the Knol-Berger smoothed matrices and unsmoothed matrices as proxies for the missing $\textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$ values for the (non-converged) Bentler-Yuan and Higham smoothed matrices, the similarity of the distributions provided evidence that the probability of missingness was not dependent on the value of $\textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$.

```{r RpopRsm-MNAR, fig.cap="Distributions of $D_{s}(\\mathbf{R}_{Pop}, \\mathbf{R}_{Sm})$ for Knol-Berger smoothed (KB) matrices and unsmoothed (None) matrices for cases where the Bentler-Yuan (BY) and Higham (APA) algorithms converged when applied to the same NPD tetrachoric correlation matrix (shown in pink) or did not converge (shown in blue). Note that the x-axes are on a logarithmic scale."}
if (generate_figs) {
  
  RpopRsm_cond_density <- results_matrix_npd %>%
    filter(smoothing_method %in% c("None", "KB"),
           fa_method == "fapa") %>%
    ggplot(aes(x = distance_Rpop_Rsm)) +
    facet_grid(. ~ smoothing_method) +
    scale_x_log10() +
    geom_density(aes(fill = (BY_converged & APA_converged)), alpha = 0.4) +
    labs(x = latex2exp::TeX("$D_{s}(\\mathbf{R}_{Pop}, \\mathbf{R}_{Sm})$"),
         fill = "BY & APA \nConverged") +
    theme_minimal() +
    theme(strip.background = element_blank(),
          strip.text.x = element_blank())
  
  RpopRsm_cond_boxplots <- results_matrix_npd %>%
    filter(smoothing_method %in% c("None", "KB"),
           fa_method == "fapa") %>%
    ggplot(aes(y = distance_Rpop_Rsm, x = (BY_converged & APA_converged),
               fill = (BY_converged & APA_converged))) +
    facet_grid( ~ smoothing_method) +
    scale_y_log10() +
    geom_boxplot(alpha = 0.4) +
    coord_flip() +
    labs(y = "", x = "", fill = "") +
    theme_minimal() +
    theme(axis.text.x = element_blank(),
          legend.position = "none")
  
  RpopRsm_cond <- RpopRsm_cond_boxplots / RpopRsm_cond_density +
    plot_layout(heights = c(1, 3))
  
  ggsave(filename = "RpopRsm_cond_density.png",
         plot = RpopRsm_cond,
         path = here("Text", "figs"),
         height = 4,
         width = 8,
         dpi = "retina")
}

knitr::include_graphics(
  path = here("Text", "figs", "RpopRsm_cond_density.png"),
  dpi = 400
)
```

Despite the evidence provided by Figure \@ref(fig:RpopRsm-MNAR) that the $\textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$ values were MCAR, ten imputed datasets were generated using the R `mice` package (van Buuren & Groothuis-Oudshoorn, 2011). For each imputed data set, predictive mean matching (Little, 1986) was used to impute missing values of $\log \textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$ using a two-level mixed-effects model with number of subjects per item, number of items per factor, number of factors, factor loading, model error, and smoothing method as predictors and a random intercept for each NPD tetrachoric correlation matrix. All numeric variables were scaled to have a mean of zero and a standard deviation of one. The number of imputed data sets (ten) was chosen based on published guidelines. For instance, both Schafer (1999) and Rubin (2004) suggest that five to ten imputated data sets should be sufficient unless the percentage of missing data is unusually high. More recently, Graham, Olchowski, & Gilreath (2007) and Bodner (2008) recommended that the number of imputated data sets should be (at a minimum) similar to the percentage of missing data. Because only `r round(mean(is.na(results_matrix_npd$distance_Rpop_Rsm)), 3) * 100`% of $\textrm{D}_s(\mathbf{R}_{\textrm{Pop}}, \mathbf{R}_{\textrm{Sm}})$ values were missing, ten imputed data sets were considered sufficient.

## Imputation Procedure for $\log \textrm{RMSE}(\mathbf{\Lambda}, \hat{\mathbf{\Lambda}})$

Non-convergence of the Higham (2002) and Bentler-Yuan (2011) algorithms also resulted in `r round(mean(is.na(results_matrix_npd[results_matrix_npd$fa_convergence != FALSE,]$loading_rmsd)), 3) * 100`% missing values of $\RMSE$ because there was no way to conduct factor analysis on a missing smoothed correlation matrix. To determine whether it was reasonable to assume that the data were MCAR, density and box plots of $\RMSE$ for the methods without non-convergence issues (Knol-Berger and no smoothing) were created. Separate density and box plots were created for cases where the Bentler-Yuan and Higham algorithms converged (when applied to the corresponding NPD correlation matrix) and those cases where at least one of the two smoothing algorithms did not converge. For both the Knol-Berger smoothed matrices and the unsmoothed NPD matrices, the distributions of $\RMSE$ for cases where the Higham and Bentler-Yuan algorithms converged and the cases where at least one did not converge were quite similar. The similarity of the distributions can be interpreted as an indication that missingness (i.e., non-convergence on the smoothing algorithms) was not related to the value of $\RMSE$. However, as a precaution against biased parameter estimates, the missing values of $\RMSE$ were imputed ten times using a two-level predictive mean matching approach similar to the one described in the previous section with number of subjects per item, number of items per factor, number of factors, factor loading, model error, smoothing method, and factor extraction method as predictors, with a random intercept for each NPD tetrachoric correlation matrix. Cases where the factor extraction procedure did not converge were not excluded from all analyses. As in the previously described imputation procedure, all numeric variables were scaled, $\RMSE$ was imputed on the log scale, and observations were grouped according to their shared NPD tetrachoric correlation matrix.

```{r loadings-MNAR, fig.cap = "Distributions of $D_{s}(\\mathbf{R}_{Pop}, \\mathbf{R}_{Sm})$ for Knol-Berger smoothed (KB) matrices and unsmoothed (None) matrices for cases where the Bentler-Yuan (BY) and Higham (APA) algorithms converged when applied to the same NPD tetrachoric correlation matrix (shown in pink) or did not converge (shown in blue). Note that the x-axes are on a logarithmic scale."}
if (generate_figs) {
  loadings_cond_density <- results_matrix_npd %>%
    filter(smoothing_method %in% c("None", "KB"),
           fa_convergence == TRUE) %>%
    ggplot(aes(x = loading_rmsd)) +
    scale_x_log10() +
    facet_grid(. ~ smoothing_method) +
    geom_density(aes(fill = (BY_converged & APA_converged)), alpha = 0.4) +
    labs(x = latex2exp::TeX("$\\; RMSE(\\mathbf{\\Lambda}, \\hat{\\mathbf{\\Lambda}})$"),
         fill = "BY & APA \nConverged") +
    theme_minimal() +
    theme(strip.background = element_blank(),
          strip.text.x = element_blank())
  
  loadings_cond_boxplots <- results_matrix_npd %>%
    filter(smoothing_method %in% c("None", "KB"),
           fa_convergence == TRUE) %>%
    ggplot(aes(y = loading_rmsd, x = (BY_converged & APA_converged),
               fill = (BY_converged & APA_converged))) +
    facet_grid( ~ smoothing_method) +
    scale_y_log10() +
    geom_boxplot(alpha = 0.4) +
    coord_flip() +
    labs(y = "", x = "", fill = "") +
    theme_minimal() +
    theme(axis.text.x = element_blank(),
          legend.position = "none")
  
  loadings_cond <- loadings_cond_boxplots / loadings_cond_density +
    plot_layout(heights = c(1, 3))
  
  ggsave(filename = "loadings_cond_density.png",
         plot = loadings_cond,
         path = here("Text", "figs"),
         height = 4,
         width = 8,
         dpi = "retina")
}

knitr::include_graphics(
  path = here("Text", "figs", "loadings_cond_density.png"),
  dpi = 400
)
```